<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MELCloud Account Configuration</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
</head>

<body>

  <div class="container mt-3">
    <div class="text-center">
      <img src="homebridge-melcloud-control.png" alt="Image" height="120" />
    </div>

    <div id="melCloudAccount" class="card card-body mt-2">
      <form id="configForm">
        <div class="text-center">
          <label id="accountName" class="fw-bold" style="font-size: 23px;">Account</label><br>
          <label id="info" class="d-block" style="font-size: 14px;"></label>
          <label id="info1" class="d-block" style="font-size: 12px;"></label>
          <label id="info2" class="d-block" style="font-size: 12px;"></label>
        </div>

        <div class="mb-2">
          <label for="name" class="form-label">Name</label>
          <input id="name" type="text" class="form-control" required>
        </div>

        <div class="mb-2">
          <label for="user" class="form-label">User Name</label>
          <input id="user" type="text" class="form-control" required>
        </div>

        <div class="mb-2 position-relative">
          <label for="passwd" class="form-label">Password</label>
          <div class="input-group">
            <input id="passwd" type="password" class="form-control" autocomplete="off" required>
            <button type="button" id="togglePasswd" class="btn btn-outline-secondary">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>

        <div class="mb-2">
          <label for="language" class="form-label">Language</label>
          <select id="language" name="language" class="form-control">
            <option value="0">English</option>
            <option value="1">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</option>
            <option value="2">ƒåe≈°tina</option>
            <option value="3">Dansk</option>
            <option value="4">Deutsch</option>
            <option value="5">Eesti</option>
            <option value="6">Espa√±ol</option>
            <option value="7">Fran√ßais</option>
            <option value="8">’Ä’°’µ’•÷Ä’•’∂</option>
            <option value="9">Latvie≈°u</option>
            <option value="10">Lietuvi≈≥</option>
            <option value="11">Magyar</option>
            <option value="12">Nederlands</option>
            <option value="13">Norwegian</option>
            <option value="14">Polski</option>
            <option value="15">Portugu√™s</option>
            <option value="16">–†—É—Å—Å–∫–∏–π</option>
            <option value="17">Suomi</option>
            <option value="18">Svenska</option>
            <option value="19">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="20">T√ºrk√ße</option>
            <option value="21">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
            <option value="22">Hrvatski</option>
            <option value="23">Rom√¢nƒÉ</option>
            <option value="24">Sloven≈°ƒçina</option>
          </select>
        </div>

        <div class="mb-2">
          <label for="displayType" class="form-label">Account Type</label>
          <select id="displayType" name="displayType" class="form-control">
            <option value="disabled">None/Disabled</option>
            <option value="melcloud">MELCloud</option>
            <option value="melcloudhome">MELCloud Home</option>
          </select>
        </div>

        <div class="text-center">
          <button id="logIn" type="button" class="btn btn-secondary">Connect to MELCloud</button>
          <button id="configButton" type="button" class="btn btn-secondary"><i class="fas fa-gear"></i></button>
        </div>
      </form>
      <div id="accountButton" class="text-center mt-2"></div>
    </div>
  </div>

  <script>
    (async () => {
      const config = await homebridge.getPluginConfig();

      if (!config.length) {
        config.push({ accounts: [] });
        await homebridge.updatePluginConfig(config);
        homebridge.showSchemaForm();
        return;
      }

      config[0].accounts ??= [];

      // üß© Deep clone ‚Äî UI-safe copy (JSON method resets references)
      const pluginConfig = JSON.parse(JSON.stringify(config));

      this.accountIndex = 0;
      const accountsCount = pluginConfig[0].accounts.length;

      for (let i = 0; i < accountsCount; i++) {
        const acc = pluginConfig[0].accounts[i];
        const button = document.createElement("button");
        button.type = "button";
        button.id = `button${i}`;
        button.className = "btn btn-primary";
        button.style.textTransform = 'none';
        button.innerText = acc.name;
        document.getElementById("accountButton").appendChild(button);

        button.addEventListener('click', async () => {
          for (let j = 0; j < accountsCount; j++) {
            document.getElementById(`button${j}`).className = (j === i ? 'btn btn-primary' : 'btn btn-secondary');
          }

          const acc = pluginConfig[0].accounts[i];
          document.getElementById('accountName').innerText = acc.name || '';
          document.getElementById('name').value = acc.name || '';
          document.getElementById('user').value = acc.user || '';
          document.getElementById('passwd').value = acc.passwd || '';
          document.getElementById('language').value = acc.language || '0';
          document.getElementById('displayType').value = acc.displayType || 'disabled';
          document.getElementById('logIn').disabled = !(acc.name && acc.user && acc.passwd && acc.language && acc.displayType);
        });

        if (i === accountsCount - 1 && accountsCount > 0)
          document.getElementById(`button0`).click();

        this.accountIndex = i;
      }

      document.getElementById('melCloudAccount').style.display = 'block';

      // Safe update
      document.getElementById('configForm').addEventListener('input', async () => {
        const acc = pluginConfig[0].accounts[this.accountIndex];
        if (!acc) return;
        acc.name = document.querySelector('#name').value;
        acc.user = document.querySelector('#user').value;
        acc.passwd = document.querySelector('#passwd').value;
        acc.language = document.querySelector('#language').value;
        acc.displayType = document.querySelector('#displayType').value;

        document.getElementById('logIn').disabled = !(acc.name && acc.user && acc.passwd && acc.language && acc.displayType);

        await homebridge.updatePluginConfig(pluginConfig);
        await homebridge.savePluginConfig(pluginConfig);
      });

      // --- Config Button Toggle ---
      const configButton = document.getElementById('configButton');
      let configButtonState = false;
      configButton.addEventListener('click', () => {
        configButtonState = !configButtonState;
        homebridge[configButtonState ? 'showSchemaForm' : 'hideSchemaForm']();
        configButton.className = configButtonState ? 'btn btn-primary' : 'btn btn-secondary';
      });

      // Password toggle
      document.getElementById('togglePasswd').addEventListener('click', () => {
        const passwdInput = document.getElementById('passwd');
        const icon = document.querySelector('#togglePasswd i');
        if (passwdInput.type === 'password') {
          passwdInput.type = 'text';
          icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
          passwdInput.type = 'password';
          icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
      });

      // --- Device Handling & Login Logic ---
      function removeStaleDevices(configDevices, melcloudDevices) {
        const melcloudIds = melcloudDevices.map(d => d.DeviceID);
        const removedDevices = [];

        for (let i = configDevices.length - 1; i >= 0; i--) {
          const device = configDevices[i];
          if (device.id !== "0" && !melcloudIds.includes(device.id)) {
            removedDevices.push(device);
            configDevices.splice(i, 1);
          }
        }
        return removedDevices;
      }

      function updateInfo(id, text, color) {
        const el = document.getElementById(id);
        if (el) {
          el.innerText = text;
          el.style.color = color;
        }
      }

      document.getElementById('logIn').addEventListener('click', async () => {
        document.getElementById(`logIn`).className = "btn btn-primary";

        updateInfo('info', 'Connecting...', 'yellow');
        homebridge.showSpinner();

        try {
          const acc = pluginConfig[0].accounts[this.accountIndex];
          const payload = { accountName: acc.name, user: acc.user, passwd: acc.passwd, language: acc.language, displayType: acc.displayType };
          const devicesInMelCloud = await homebridge.request('/connect', payload);

          // Initialize devices arrays
          const newDevices = { ata: [], ataPresets: [], atw: [], atwPresets: [], erv: [], ervPresets: [] };
          const devicesByType = { ata: [], atw: [], erv: [] };

          devicesInMelCloud.forEach(d => {
            if (d.Type === 0) devicesByType.ata.push(d);
            if (d.Type === 1) devicesByType.atw.push(d);
            if (d.Type === 3) devicesByType.erv.push(d);
          });

          acc.ataDevices ??= [];
          acc.atwDevices ??= [];
          acc.ervDevices ??= [];

          const removedAta = removeStaleDevices(acc.ataDevices, devicesByType.ata);
          const removedAtw = removeStaleDevices(acc.atwDevices, devicesByType.atw);
          const removedErv = removeStaleDevices(acc.ervDevices, devicesByType.erv);

          const handleDevices = (devicesInCloud, devicesInConfig, typeString, newArr, newPresets) => {
            devicesInCloud.forEach(device => {
              const { DeviceID: id, Type: type, DeviceName: name, Presets: presets = [] } = device;
              const devObj = structuredClone({
                id,
                type,
                typeString,
                name,
                displayMode: 1,
                presets: [],
                buttonsSensors: []
              });

              if (!devicesInConfig.some(d => d.id === id)) {
                devicesInConfig.push(devObj);
                newArr.push(structuredClone(devObj));
              }

              presets.forEach(preset => {
                const p = structuredClone({
                  id: preset.ID,
                  name: preset.NumberDescription,
                  displayType: 0,
                  namePrefix: false
                });

                const devConfig = devicesInConfig.find(d => d.id === id);
                if (devConfig && !devConfig.presets.some(x => x.id === p.id)) {
                  devConfig.presets.push(p);
                  newPresets.push(structuredClone(p));
                }
              });
            });
          };

          handleDevices(devicesByType.ata, acc.ataDevices, "Air Conditioner", newDevices.ata, newDevices.ataPresets);
          handleDevices(devicesByType.atw, acc.atwDevices, "Heat Pump", newDevices.atw, newDevices.atwPresets);
          handleDevices(devicesByType.erv, acc.ervDevices, "Energy Recovery Ventilation", newDevices.erv, newDevices.ervPresets);

          const newDevicesCount = newDevices.ata.length + newDevices.atw.length + newDevices.erv.length;
          const newPresetsCount = newDevices.ataPresets.length + newDevices.atwPresets.length + newDevices.ervPresets.length;
          const removedDevicesCount = removedAta.length + removedAtw.length + removedErv.length;

          if (!newDevicesCount && !newPresetsCount && !removedDevicesCount) {
            updateInfo('info', 'No changes detected.', 'white');
          } else {
            if (newDevicesCount)
              updateInfo('info', `Found new devices: ATA: ${newDevices.ata.length}, ATW: ${newDevices.atw.length}, ERV: ${newDevices.erv.length}.`, 'green');
            if (newPresetsCount)
              updateInfo('info1', `Found new presets: ATA: ${newDevices.ataPresets.length}, ATW: ${newDevices.atwPresets.length}, ERV: ${newDevices.ervPresets.length}.`, 'green');
            if (removedDevicesCount)
              updateInfo('info2', `Removed devices: ATA: ${removedAta.length}, ATW: ${removedAtw.length}, ERV: ${removedErv.length}.`, 'orange');
          }

          await homebridge.updatePluginConfig(pluginConfig);
          await homebridge.savePluginConfig(pluginConfig);
          document.getElementById('logIn').className = "btn btn-secondary";

        } catch (error) {
          updateInfo('info', 'Check Your credentials data and try again.', 'yellow');
          updateInfo('info1', `Error: ${JSON.stringify(error)}`, 'red');
          document.getElementById('logIn').className = "btn btn-secondary";
        } finally {
          homebridge.hideSpinner();
        }
      });

    })();
  </script>
</body>

</html>