<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MELCloud Account Configuration</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
</head>

<div class="container mt-3">
  <div class="text-center">
    <img src="homebridge-melcloud-control.png" alt="Image" height="120" />
  </div>

  <div id="melCloudAccount" class="card card-body mt-2">
    <form id="configForm">
      <div class="text-center">
        <label id="accountName" class="fw-bold" style="font-size: 23px;">Account</label><br>
        <label id="info" class="d-block" style="font-size: 14px;"></label>
        <label id="info1" class="d-block" style="font-size: 12px;"></label>
        <label id="info2" class="d-block" style="font-size: 12px;"></label>
      </div>

      <div class="mb-2">
        <label for="name" class="form-label">Name</label>
        <input id="name" type="text" class="form-control" required>
      </div>

      <div class="mb-2">
        <label for="user" class="form-label">User Name</label>
        <input id="user" type="text" class="form-control" required>
      </div>

      <div class="mb-2 position-relative">
        <label for="passwd" class="form-label">Password</label>
        <div class="input-group">
          <input id="passwd" type="password" class="form-control" autocomplete="off" required>
          <button type="button" id="togglePasswd" class="btn btn-outline-secondary">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <div class="mb-2">
        <label for="language" class="form-label">Language</label>
        <select id="language" name="language" class="form-control">
          <option value="0">English</option>
          <option value="1">Български</option>
          <option value="2">Čeština</option>
          <option value="3">Dansk</option>
          <option value="4">Deutsch</option>
          <option value="5">Eesti</option>
          <option value="6">Español</option>
          <option value="7">Français</option>
          <option value="8">Հայերեն</option>
          <option value="9">Latviešu</option>
          <option value="10">Lietuvių</option>
          <option value="11">Magyar</option>
          <option value="12">Nederlands</option>
          <option value="13">Norwegian</option>
          <option value="14">Polski</option>
          <option value="15">Português</option>
          <option value="16">Русский</option>
          <option value="17">Suomi</option>
          <option value="18">Svenska</option>
          <option value="19">Українська</option>
          <option value="20">Türkçe</option>
          <option value="21">Ελληνικά</option>
          <option value="22">Hrvatski</option>
          <option value="23">Română</option>
          <option value="24">Slovenščina</option>
        </select>
      </div>

      <div class="mb-2">
        <label for="accountType" class="form-label">Account Type</label>
        <select id="accountType" name="accountType" class="form-control">
          <option value="disabled">None/Disabled</option>
          <option value="melcloud">MELCloud</option>
          <option value="melcloudhome">MELCloud Home</option>
        </select>
      </div>

      <div class="text-center">
        <button id="logIn" type="button" class="btn btn-secondary">Connect to MELCloud</button>
        <button id="configButton" type="button" class="btn btn-secondary"><i class="fas fa-gear"></i></button>
      </div>
    </form>
    <div id="accountButton" class="d-flex flex-wrap justify-content-center gap-1 mt-3"></div>
  </div>
</div>

<script>
  (async () => {
    const pluginConfig = await homebridge.getPluginConfig();

    if (!pluginConfig.length) {
      pluginConfig.push({});
      await homebridge.updatePluginConfig(pluginConfig);
      homebridge.showSchemaForm();
      return;
    }

    const accounts = pluginConfig[0].accounts || [];
    const accountsCount = accounts.length;

    const container = document.getElementById("accountButton");
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    container.style.justifyContent = 'center';
    container.style.gap = '0.25rem';
    container.style.alignItems = 'center';

    const formElements = {
      accountName: document.getElementById('accountName'),
      info: document.getElementById('info'),
      info1: document.getElementById('info1'),
      info2: document.getElementById('info2'),
      name: document.getElementById('name'),
      user: document.getElementById('user'),
      passwd: document.getElementById('passwd'),
      language: document.getElementById('language'),
      accountType: document.getElementById('accountType'),
      logIn: document.getElementById('logIn')
    };

    // Tworzenie przycisków
    accounts.forEach((account, i) => {
      this.account = account;

      const button = document.createElement("button");
      button.type = "button";
      button.id = `button${i}`;
      button.className = "btn btn-primary";
      button.style.textTransform = 'none';
      button.innerText = account.name || `Account ${i + 1}`;
      container.appendChild(button);

      button.addEventListener('click', async () => {
        this.account = account;

        // Zmieniamy klasę wszystkich przycisków
        accounts.forEach((_, j) => {
          document.getElementById(`button${j}`).className = (j === i ? 'btn btn-primary' : 'btn btn-secondary');
        });

        // Ustawiamy formularz
        formElements.accountName.innerText = account.name || '';
        formElements.info.innerText = ``;
        formElements.info1.innerText = '';
        formElements.info2.innerText = '';
        formElements.name.value = account.name || '';
        formElements.user.value = account.user || '';
        formElements.passwd.value = account.passwd || '';
        formElements.language.value = account.language || '0';
        formElements.accountType.value = account.type || 'disabled';
        formElements.logIn.disabled = !(account.name && account.user && account.passwd && account.language && account.type);
      });
    });

    // Klikamy pierwszy przycisk po zakończeniu pętli
    if (accountsCount > 0) document.getElementById('button0').click();

    // Jeden listener input dla całego formularza
    document.getElementById('configForm').addEventListener('input', async () => {
      const account = this.account;
      if (!account) return;

      account.name = formElements.name.value;
      account.user = formElements.user.value;
      account.passwd = formElements.passwd.value;
      account.language = formElements.language.value;
      account.type = formElements.accountType.value;

      formElements.logIn.disabled = !(account.name && account.user && account.passwd && account.language && account.type);

      await homebridge.updatePluginConfig(pluginConfig);
      await homebridge.savePluginConfig(pluginConfig);
    });

    document.getElementById('melCloudAccount').style.display = 'block';

    // Config Button Toggle
    const configButton = document.getElementById('configButton');
    let configButtonState = false;
    configButton.addEventListener('click', () => {
      configButtonState = !configButtonState;
      homebridge[configButtonState ? 'showSchemaForm' : 'hideSchemaForm']();
      configButton.className = configButtonState ? 'btn btn-primary' : 'btn btn-secondary';
    });

    // Password toggle
    document.getElementById('togglePasswd').addEventListener('click', () => {
      const passwdInput = document.getElementById('passwd');
      const icon = document.querySelector('#togglePasswd i');
      if (passwdInput.type === 'password') {
        passwdInput.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        passwdInput.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    });

    // Device Handling & Login Logic
    function removeStaleDevices(configDevices, melcloudDevices) {
      const melcloudIds = melcloudDevices.map(d => d.DeviceID);
      const removedDevices = [];

      for (let i = configDevices.length - 1; i >= 0; i--) {
        const device = configDevices[i];
        if (!melcloudIds.includes(device.id)) {
          removedDevices.push(device);
          configDevices.splice(i, 1);
        }
      }
      return removedDevices;
    }

    function updateInfo(id, text, color) {
      const el = document.getElementById(id);
      if (el) {
        el.innerText = text;
        el.style.color = color;
      }
    }

    document.getElementById('logIn').addEventListener('click', async () => {
      homebridge.showSpinner();

      document.getElementById(`logIn`).className = "btn btn-primary";
      updateInfo('info', '', 'white');
      updateInfo('info1', '', 'white');
      updateInfo('info2', '', 'white');

      try {
        const account = this.account;
        const response = await homebridge.request('/connect', account);
        if (!response.State) {
          homebridge.hideSpinner();
          updateInfo('info', response.Info);
          return;
        }

        // Initialize devices arrays
        const newInMelCloud = { ata: [], ataPresets: [], ataSchedules: [], atw: [], atwPresets: [], atwSchedules: [], erv: [], ervPresets: [], ervSchedules: [], scenes: [] };
        const devicesInMelCloudByType = { ata: [], atw: [], erv: [] };
        const scenesInMelCloud = response.Scenes ?? []

        response.Devices.forEach(device => {
          if (device.Type === 0) devicesInMelCloudByType.ata.push(device);
          if (device.Type === 1) devicesInMelCloudByType.atw.push(device);
          if (device.Type === 3) devicesInMelCloudByType.erv.push(device);
        });

        account.ataDevices = (account.ataDevices ?? []).filter(d => String(d.id) !== '0');
        account.atwDevices = (account.atwDevices ?? []).filter(d => String(d.id) !== '0');
        account.ervDevices = (account.ervDevices ?? []).filter(d => String(d.id) !== '0');

        const removedAta = removeStaleDevices(account.ataDevices, devicesInMelCloudByType.ata);
        const removedAtw = removeStaleDevices(account.atwDevices, devicesInMelCloudByType.atw);
        const removedErv = removeStaleDevices(account.ervDevices, devicesInMelCloudByType.erv);

        const handleDevices = (devicesInMelCloud, devicesInConfig, deviceTypeString, newDevices, newPresets, newSchedules, newScenes) => {
          try {
            const configDevicesMap = new Map(devicesInConfig.map(dev => [String(dev.id), dev]));

            devicesInMelCloud.forEach(device => {
              const deviceId = String(device.DeviceID);
              let deviceInConfig = configDevicesMap.get(deviceId);

              // === Create device if missing ===
              if (!deviceInConfig) {
                deviceInConfig = {
                  id: deviceId,
                  type: device.Type,
                  deviceTypeString,
                  displayType: 0,
                  name: device.DeviceName
                };
                devicesInConfig.push(deviceInConfig);
                newDevices.push(deviceInConfig);
                configDevicesMap.set(deviceId, deviceInConfig);
              }

              //only for melcloud
              if (account.type === 'melcloud') {

                // === Process presets ===
                const presetsInMelCloud = device.Presets || [];
                const presetsInConfig = (deviceInConfig.presets ?? []).filter(p => String(p.id) !== '0');
                const presetIds = new Set(presetsInConfig.map(p => String(p.id)));

                presetsInMelCloud.forEach((preset, index) => {
                  const presetId = String(preset.ID);
                  if (!presetIds.has(presetId)) {
                    const presetObj = {
                      id: presetId,
                      displayType: 0,
                      name: preset.NumberDescription || `Preset ${index}`,
                      namePrefix: false
                    };
                    presetsInConfig.push(presetObj);
                    newPresets.push(presetObj);
                    presetIds.add(presetId);
                  }
                });
              }

              //only for melcloudhome
              if (account.type === 'melcloudhome') {

                // === Process schedules ===
                const schedulesInMelCloud = device.Schedule || [];
                const schedulesInConfig = (deviceInConfig.schedules ?? []).filter(s => String(s.id) !== '0');
                const scheduleIds = new Set(schedulesInConfig.map(s => String(s.id)));

                schedulesInMelCloud.forEach((schedule, index) => {
                  const scheduleId = String(schedule.Id);
                  if (!scheduleIds.has(scheduleId)) {
                    const scheduleObj = {
                      id: scheduleId,
                      displayType: 0,
                      name: `Schedule ${index}`,
                      namePrefix: false
                    };
                    schedulesInConfig.push(scheduleObj);
                    newSchedules.push(scheduleObj);
                    scheduleIds.add(scheduleId);
                  }
                });

                // === Process scenes ===
                const scenesInConfig = (deviceInConfig.scenes ?? []).filter(s => String(s.id) !== '0');
                const sceneIds = new Set(scenesInConfig.map(s => String(s.id)));

                scenesInMelCloud.forEach((scene, index) => {
                  const sceneId = String(scene.Id);
                  if (!sceneIds.has(sceneId)) {
                    const sceneObj = {
                      id: sceneId,
                      displayType: 0,
                      name: scene.Name || `Scene ${index}`,
                      namePrefix: false
                    };
                    scenesInConfig.push(sceneObj);
                    newScenes.push(sceneObj);
                    sceneIds.add(sceneId);
                  }
                });
              }
            });

            // Return filtered devicesInConfig to make sure upstream code uses it
            return devicesInConfig;
          } catch (error) {
            updateInfo('info', `Error while processing device: ${JSON.stringify(error)}`, 'red');
          }
        };

        account.ataDevices = handleDevices(devicesInMelCloudByType.ata, account.ataDevices, "Air Conditioner", newInMelCloud.ata, newInMelCloud.ataPresets, newInMelCloud.ataSchedules, newInMelCloud.scenes);
        account.atwDevices = handleDevices(devicesInMelCloudByType.atw, account.atwDevices, "Heat Pump", newInMelCloud.atw, newInMelCloud.atwPresets, newInMelCloud.atwSchedules, newInMelCloud.scenes);
        account.ervDevices = handleDevices(devicesInMelCloudByType.erv, account.ervDevices, "Energy Recovery Ventilation", newInMelCloud.erv, newInMelCloud.ervPresets, newInMelCloud.ervSchedules, newInMelCloud.scenes);

        const newDevicesCount = newInMelCloud.ata.length + newInMelCloud.atw.length + newInMelCloud.erv.length;
        const newPresetsCount = newInMelCloud.ataPresets.length + newInMelCloud.atwPresets.length + newInMelCloud.ervPresets.length;
        const newSchedulesCount = newInMelCloud.ataSchedules.length + newInMelCloud.atwSchedules.length + newInMelCloud.ervSchedules.length;
        const newScenesCount = newInMelCloud.scenes.length;
        const removedDevicesCount = removedAta.length + removedAtw.length + removedErv.length;

        if (!newDevicesCount && !newPresetsCount && !newSchedulesCount && !newScenesCount && !removedDevicesCount) {
          updateInfo('info', 'No changes detected.', 'white');
        } else {
          if (newDevicesCount)
            updateInfo('info', `Found new devices: ${newInMelCloud.ata.length ? `ATA: ${newInMelCloud.ata.length},` : ''} ${newInMelCloud.atw.length ? `ATW: ${newInMelCloud.atw.length},` : ''} ${newInMelCloud.erv.length ? `ERV: ${newInMelCloud.erv.length},` : ''}.`, 'green');
          if (newPresetsCount)
            updateInfo('info1', `Found new presets: ${newInMelCloud.ataPresets.length ? `ATA: ${newInMelCloud.ataPresets.length},` : ''} ${newInMelCloud.atwPresets.length ? `ATW: ${newInMelCloud.atwPresets.length},` : ''} ${newInMelCloud.ervPresets.length ? `ERV: ${newInMelCloud.ervPresets.length}` : ''}.`, 'green');
          if (newScenesCount || newSchedulesCount)
            updateInfo('info1', `Found new ${newSchedulesCount ? `schedules:` : ''} ${newInMelCloud.ataSchedules.length ? `ATA: ${newInMelCloud.ataSchedules.length},` : ''} ${newInMelCloud.atwSchedules.length ? `ATW: ${newInMelCloud.atwSchedules.length},` : ''}  ${newInMelCloud.ervSchedules.length ? `ERV: ${newInMelCloud.ervSchedules.length},` : ''} ${newScenesCount ? `scenes: ${newScenesCount}` : ''}.`, 'green');
          if (removedDevicesCount)
            updateInfo('info2', `Removed devices: ${removedAta.length ? `ATA: ${removedAta.length},` : ''} ${removedAtw.length ? `ATW: ${removedAtw.length},` : ''} ${removedErv.length ? `ERV: ${removedErv.length}` : ''}.`, 'orange');
        }

        await homebridge.updatePluginConfig(pluginConfig);
        await homebridge.savePluginConfig(pluginConfig);
      } catch (error) {
        updateInfo('info', `Prepare config error ${JSON.stringify(error)}`, 'red');
        document.getElementById('logIn').className = "btn btn-secondary";
      } finally {
        document.getElementById('logIn').className = "btn btn-secondary";
        homebridge.hideSpinner();
      }
    });

  })();
</script>